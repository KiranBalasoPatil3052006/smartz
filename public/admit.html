<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy"
    content="connect-src 'self' https://smart-cart-app-h47v.onrender.com http://localhost:5000;">
  <title>Admin - Dashboard</title>
  <link rel="stylesheet" href="AdmitStyle.css" />
  <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
  <style>
    h2 {
      margin-top: 25px;
      color: #350410de;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      background: white;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #350410de;
      color: #fff;
    }

    .btn {
      background: #350410de;
      color: #fff;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 8px 5px;
    }

    .btn:hover {
      background: #5c0a1c;
    }

    #messageBox {
      margin-top: 15px;
      font-size: 15px;
      font-weight: bold;
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      display: none;
    }

    #messageBox.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    #messageBox.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
  </style>
</head>

<body>
  <div class="sidebar" id="sidebar">
    <a href="#" onclick="showMainPage()">Home</a>
    <a href="#" onclick="showCustomers()">Customers</a>
    <a href="adminlogin.html">Logout</a>
  </div>

  <div class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
    <span></span><span></span><span></span>
  </div>

  <div class="main-content" id="mainContent">
    <div class="container">
      <h1 class="admin-heading">Smart Cart - Admin</h1>

      <div class="btn-group">
        <button id="back-btn" class="btn" style="display:none;" onclick="backToHome()">Back</button>
        <button id="cash-payment-btn" class="btn" onclick="showCashPayments()">Cash Payments</button>
        <button id="online-payment-btn" class="btn" onclick="showOnlinePayments()">Online Payments</button>
        <button id="cashier-code-btn" class="btn" onclick="showCashierCodes()">Cashier Codes</button>
      </div>

      <!-- Message -->
      <div id="messageBox"></div>

      <!-- Cashier Codes -->
      <div id="cashier-code-display" style="display:none;">
        <h2>Pending Cashier Codes</h2>
        <table>
          <thead>
            <tr>
              <th>Mobile</th>
              <th>Cashier Code</th>
              <th>Date Created</th>
            </tr>
          </thead>
          <tbody id="pending-code-body"></tbody>
        </table>

        <h2>Verified Cashier Codes</h2>
        <table>
          <thead>
            <tr>
              <th>Mobile</th>
              <th>Cashier Code</th>
              <th>Date Verified</th>
            </tr>
          </thead>
          <tbody id="verified-code-body"></tbody>
        </table>
      </div>

      <!-- Customer Table -->
      <div id="customer-section" style="display:none;">
        <h2>All Customers</h2>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Mobile</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody id="customer-body"></tbody>
        </table>
      </div>

      <!-- Summary & Product History -->
      <div id="summary-history-section">
        <h2 id="summary-title">Customer Purchase Summary</h2>
        <table id="summary-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Mobile</th>
              <th>Date</th>
              <th>Time</th>
              <th>Amount</th>
              <th>Payment</th>
            </tr>
          </thead>
          <tbody id="summary-body"></tbody>
        </table>

        <h2 id="history-title">All Products Purchased</h2>
        <table id="history-table">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Barcode</th>
              <th>Product</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Total</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>

    </div>
  </div>
  <script src="config.js"></script>

  <script>
    // admin.js
    const messageBox = document.getElementById("messageBox");

    function showMessage(msg, type) {
      messageBox.textContent = msg;
      messageBox.className = type === "success" ? "success" : "error";
    }

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
      document.getElementById("mainContent").classList.toggle("active");
      document.querySelector(".menu-toggle").classList.toggle("open");
    }

    function resetView() {
      document.getElementById("summary-history-section").style.display = "none";
      document.getElementById("customer-section").style.display = "none";
      document.getElementById("cashier-code-display").style.display = "none";
      document.getElementById("back-btn").style.display = "inline-block";
      document.getElementById("summary-body").innerHTML = "";
      document.getElementById("history-body").innerHTML = "";
      document.getElementById("customer-body").innerHTML = "";
      document.getElementById("pending-code-body").innerHTML = "";
      document.getElementById("verified-code-body").innerHTML = "";
    }

    function backToHome() {
      document.getElementById("summary-history-section").style.display = "block";
      document.getElementById("customer-section").style.display = "none";
      document.getElementById("cashier-code-display").style.display = "none";
      document.getElementById("back-btn").style.display = "none";
      loadFullPurchaseHistory();
    }

    function loadFullPurchaseHistory() {
      document.getElementById("summary-history-section").style.display = "block";
      fetch(`${BASE_URL}/purchase-history`)
        .then(res => res.json())
        .then(data => renderPurchaseHistory(data))
        .catch(() => showMessage("Failed to load purchase history", "error"));
    }

    function renderPurchaseHistory(data) {
      const summaryBody = document.getElementById("summary-body");
      const historyBody = document.getElementById("history-body");
      summaryBody.innerHTML = "";
      historyBody.innerHTML = "";

      data.forEach(entry => {
        let total = 0;
        entry.products.forEach(product => {
          const row = document.createElement("tr");
          row.innerHTML = `
        <td>${entry.name}</td>
        <td>${product.barcode}</td>
        <td>${product.name}</td>
        <td>${product.price}</td>
        <td>${product.quantity}</td>
        <td>₹${product.price * product.quantity}</td>
        <td>${new Date(entry.date).toLocaleDateString()}</td>
      `;
          historyBody.appendChild(row);
          total += product.price * product.quantity;
        });

        const date = new Date(entry.date);
        const summaryRow = document.createElement("tr");
        summaryRow.innerHTML = `
      <td>${entry.name}</td>
      <td>${entry.mobile}</td>
      <td>${date.toLocaleDateString()}</td>
      <td>${date.toLocaleTimeString()}</td>
      <td>₹${total}</td>
      <td>${entry.paymentMethod || 'Cash'} ${entry.paymentMethod === 'cash' ? `(${entry.cashierCode || 'N/A'})` : ''}</td>
    `;
        summaryBody.appendChild(summaryRow);
      });
    }

    function showCustomers() {
      resetView();
      document.getElementById("customer-section").style.display = "block";
      fetch(`${BASE_URL}/customers`)
        .then(res => res.json())
        .then(data => {
          const customerBody = document.getElementById("customer-body");
          data.forEach(c => {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${c.name}</td><td>${c.mobile}</td><td>${c.email}</td>`;
            customerBody.appendChild(row);
          });
        })
        .catch(() => showMessage("Failed to load customers", "error"));
    }

    function showCashPayments() {
      resetView();
      document.getElementById("summary-history-section").style.display = "block";
      fetch(`${BASE_URL}/purchases/cash`)
        .then(res => res.json())
        .then(data => renderPurchaseHistory(data))
        .then(loadPendingCash)
        .catch(() => showMessage("Failed to load cash payments", "error"));
    }

    function loadPendingCash() {
      fetch(`${BASE_URL}/cash-intents`)
        .then(res => res.json())
        .then(data => {
          const summaryBody = document.getElementById("summary-body");
          data.forEach(intent => {
            const row = document.createElement("tr");
            row.innerHTML = `<td>--</td><td>${intent.mobile}</td><td>--</td><td>--</td><td>--</td><td><strong>Pending Cash (${intent.cashierCode})</strong></td>`;
            summaryBody.appendChild(row);
          });
        });
    }

    function showOnlinePayments() {
      resetView();
      document.getElementById("summary-history-section").style.display = "block";
      fetch(`${BASE_URL}/purchases/online`)
        .then(res => res.json())
        .then(data => renderPurchaseHistory(data))
        .catch(() => showMessage("Failed to load online payments", "error"));
    }

    function showCashierCodes() {
      resetView();
      document.getElementById("cashier-code-display").style.display = "block";

      fetch(`${BASE_URL}/cash-intents`)
        .then(res => res.json())
        .then(data => {
          const pendingBody = document.getElementById("pending-code-body");
          pendingBody.innerHTML = "";
          data.forEach(intent => {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${intent.mobile}</td><td>${intent.cashierCode}</td><td>${new Date(intent.date).toLocaleString()}</td>`;
            pendingBody.appendChild(row);
          });
        });

      fetch(`${BASE_URL}/cashier-code-history`)
        .then(res => res.json())
        .then(history => {
          const verifiedBody = document.getElementById("verified-code-body");
          verifiedBody.innerHTML = "";
          history.forEach(entry => {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${entry.mobile}</td><td>${entry.cashierCode}</td><td>${new Date(entry.createdAt).toLocaleString()}</td>`;
            verifiedBody.appendChild(row);
          });
        });
    }

    // Initial load
    loadFullPurchaseHistory();

  </script>
</body>

</html>