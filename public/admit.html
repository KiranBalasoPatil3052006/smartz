<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy"
        content="connect-src 'self' https://smart-cart-app-h47v.onrender.com http://localhost:5000;">
    <title>Admin - Dashboard</title>
    <link rel="stylesheet" href="AdmitStyle.css" />
    <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
</head>

<body>
    <div class="sidebar" id="sidebar">
        <a href="#" onclick="showMainPage()">Home</a>
        <a href="#" onclick="showCustomers()">Customers</a>
        <a href="#" onclick="showProductManagement()">Product Manage</a>
        <a href="adminlogin.html">Logout</a>
    </div>

    <div class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
    </div>

    <div class="main-content" id="mainContent">
        <div class="container">
            <h1 class="admin-heading">Smart Cart - Admin</h1>

            <div class="btn-group" id="main-buttons">
                <button id="back-btn" class="btn" style="display:none;" onclick="backToHome()">Back</button>
                <button id="cash-payment-btn" class="btn" onclick="showCashPayments()">Cash Payments</button>
                <button id="online-payment-btn" class="btn" onclick="showOnlinePayments()">Online Payments</button>
                <button id="cashier-code-btn" class="btn" onclick="showCashierCodes()">Cashier Codes</button>
            </div>

            <div id="messageBox"></div>

            <!-- Cashier Codes -->
            <div id="cashier-code-display" style="display:none;">
                <h2>Pending Cashier Codes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Mobile</th>
                            <th>Cashier Code</th>
                            <th>Date Created</th>
                        </tr>
                    </thead>
                    <tbody id="pending-code-body"></tbody>
                </table>

                <h2>Verified Cashier Codes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Mobile</th>
                            <th>Cashier Code</th>
                            <th>Date Verified</th>
                        </tr>
                    </thead>
                    <tbody id="verified-code-body"></tbody>
                </table>
            </div>

            <!-- Customers -->
            <div id="customer-section" style="display:none;">
                <h2>All Customers</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody id="customer-body"></tbody>
                </table>
            </div>

            <!-- Summary & Product History -->
            <div id="summary-history-section">
                <h2 id="summary-title">Customer Purchase Summary</h2>
                <table id="summary-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Amount</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body"></tbody>
                </table>

                <h2 id="history-title">All Products Purchased</h2>
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Barcode</th>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Total</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>

            <!-- Product Management Section -->
            <div id="product-manage-section" style="display:none;">
                <h2>Product Management</h2>

                <form id="add-product-form">
                    <label for="product-name">Product Name:</label>
                    <input type="text" id="product-name" required placeholder="Enter product name" />
                    <label for="product-barcode">Barcode (UPC-A):</label>
                    <input type="text" id="product-barcode" required pattern="\d{12}" maxlength="12"
                        placeholder="12-digit barcode" />
                    <label for="product-price">Price (₹):</label>
                    <input type="number" id="product-price" min="0" step="0.01" required placeholder="Price" />
                    <button type="submit" class="btn">Add Product</button>
                </form>

                <input type="text" id="barcode-search" placeholder="Search by Barcode..." maxlength="12" />

                <table>
                    <thead>
                        <tr>
                            <th>Barcode</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body"></tbody>
                </table>

                <div id="edit-modal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeEditModal()">&times;</span>
                        <h2>Edit Product</h2>
                        <form id="edit-product-form">
                            <input type="hidden" id="edit-product-id" />
                            <label for="edit-product-name">Product Name:</label>
                            <input type="text" id="edit-product-name" required />
                            <label for="edit-product-barcode">Barcode (UPC-A):</label>
                            <input type="text" id="edit-product-barcode" readonly />
                            <label for="edit-product-price">Price (₹):</label>
                            <input type="number" id="edit-product-price" min="0" step="0.01" required />
                            <button type="submit" class="btn">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>

    <script>
        const BASE_URL = window.location.origin;
        const messageBox = document.getElementById("messageBox");

        function showMessage(msg, type) {
            messageBox.textContent = msg;
            messageBox.className = type === "success" ? "success" : "error";
            messageBox.style.display = "block";
            setTimeout(() => { messageBox.style.display = "none"; }, 3000);
        }

        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("active");
            document.getElementById("mainContent").classList.toggle("active");
            document.querySelector(".menu-toggle").classList.toggle("open");
        }

        function resetView() {
            [
                "summary-history-section",
                "customer-section",
                "cashier-code-display",
                "product-manage-section"
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = "none";
            });

            document.getElementById("back-btn").style.display = "none";
            document.getElementById("summary-body").innerHTML = "";
            document.getElementById("history-body").innerHTML = "";
            document.getElementById("customer-body").innerHTML = "";
            document.getElementById("pending-code-body").innerHTML = "";
            document.getElementById("verified-code-body").innerHTML = "";
            document.getElementById("product-table-body").innerHTML = "";
            document.getElementById("barcode-search").value = "";

            const addForm = document.getElementById("add-product-form");
            if (addForm) addForm.reset();

            const editForm = document.getElementById("edit-product-form");
            if (editForm) editForm.reset();
        }

        function showMainPage() {
            resetView();
            document.getElementById("summary-history-section").style.display = "block";
            document.getElementById("back-btn").style.display = "none";
            loadFullPurchaseHistory();
        }

        function showCustomers() {
            resetView();
            document.getElementById("customer-section").style.display = "block";
            fetch(`${BASE_URL}/customers`)
                .then(res => res.json())
                .then(data => {
                    const customerBody = document.getElementById("customer-body");
                    data.forEach(c => {
                        const row = document.createElement("tr");
                        row.innerHTML = `<td>${c.name}</td><td>${c.mobile}</td><td>${c.email}</td>`;
                        customerBody.appendChild(row);
                    });
                })
                .catch(() => showMessage("Failed to load customers", "error"));
        }

        function showCashPayments() {
            resetView();
            document.getElementById("summary-history-section").style.display = "block";
            fetch(`${BASE_URL}/purchases/cash`)
                .then(res => res.json())
                .then(data => renderPurchaseHistory(data))
                .then(loadPendingCash)
                .catch(() => showMessage("Failed to load cash payments", "error"));
        }

        function loadPendingCash() {
            fetch(`${BASE_URL}/cash-intents`)
                .then(res => res.json())
                .then(data => {
                    const summaryBody = document.getElementById("summary-body");
                    data.forEach(intent => {
                        const row = document.createElement("tr");
                        row.innerHTML =
                            `<td>--</td><td>${intent.mobile}</td><td>--</td><td>--</td><td>--</td><td><strong>Pending Cash (${intent.cashierCode})</strong></td>`;
                        summaryBody.appendChild(row);
                    });
                });
        }

        function showOnlinePayments() {
            resetView();
            document.getElementById("summary-history-section").style.display = "block";
            fetch(`${BASE_URL}/purchases/online`)
                .then(res => res.json())
                .then(data => renderPurchaseHistory(data))
                .catch(() => showMessage("Failed to load online payments", "error"));
        }

        function showCashierCodes() {
            resetView();
            document.getElementById("cashier-code-display").style.display = "block";

            fetch(`${BASE_URL}/cash-intents`)
                .then(res => res.json())
                .then(data => {
                    const pendingBody = document.getElementById("pending-code-body");
                    pendingBody.innerHTML = "";
                    data.forEach(intent => {
                        const row = document.createElement("tr");
                        row.innerHTML =
                            `<td>${intent.mobile}</td><td>${intent.cashierCode}</td><td>${new Date(intent.date).toLocaleString()}</td>`;
                        pendingBody.appendChild(row);
                    });
                });

            fetch(`${BASE_URL}/cashier-code-history`)
                .then(res => res.json())
                .then(history => {
                    const verifiedBody = document.getElementById("verified-code-body");
                    verifiedBody.innerHTML = "";
                    history.forEach(entry => {
                        const row = document.createElement("tr");
                        row.innerHTML =
                            `<td>${entry.mobile}</td><td>${entry.cashierCode}</td><td>${new Date(entry.createdAt).toLocaleString()}</td>`;
                        verifiedBody.appendChild(row);
                    });
                });
        }

        function loadFullPurchaseHistory() {
            resetView();
            document.getElementById("summary-history-section").style.display = "block";
            fetch(`${BASE_URL}/purchase-history`)
                .then(res => res.json())
                .then(data => renderPurchaseHistory(data))
                .catch(() => showMessage("Failed to load purchase history", "error"));
        }

        function renderPurchaseHistory(data) {
            const summaryBody = document.getElementById("summary-body");
            const historyBody = document.getElementById("history-body");
            summaryBody.innerHTML = "";
            historyBody.innerHTML = "";

            data.forEach(entry => {
                let total = 0;
                entry.products.forEach(product => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
            <td>${entry.name}</td>
            <td>${product.barcode}</td>
            <td>${product.name}</td>
            <td>${product.price}</td>
            <td>${product.quantity}</td>
            <td>₹${(product.price * product.quantity).toFixed(2)}</td>
            <td>${new Date(entry.date).toLocaleDateString()}</td>`;
                    historyBody.appendChild(row);
                    total += product.price * product.quantity;
                });

                const date = new Date(entry.date);
                const summaryRow = document.createElement("tr");
                summaryRow.innerHTML = `
          <td>${entry.name}</td>
          <td>${entry.mobile}</td>
          <td>${date.toLocaleDateString()}</td>
          <td>${date.toLocaleTimeString()}</td>
          <td>₹${total.toFixed(2)}</td>
          <td>${entry.paymentMethod || 'Cash'} ${entry.paymentMethod === 'cash' ? `(${entry.cashierCode || 'N/A'})` : ''}</td>`;
                summaryBody.appendChild(summaryRow);
            });
        }

        function showProductManagement() {
            resetView();
            document.getElementById("product-manage-section").style.display = "block";
            document.getElementById("back-btn").style.display = "inline-block";
            fetchProducts();
        }

        function backToHome() {
            resetView();
            document.getElementById("summary-history-section").style.display = "block";
            document.getElementById("back-btn").style.display = "none";
            loadFullPurchaseHistory();
        }

        function clearProductForm() {
            document.getElementById("add-product-form").reset();
        }

        function fetchProducts(searchBarcode = null) {
            fetch(`${BASE_URL}/products`)
                .then(res => res.json())
                .then(products => {
                    const tbody = document.getElementById("product-table-body");
                    tbody.innerHTML = "";
                    if (searchBarcode) {
                        const found = products.find(p => p.barcode === searchBarcode);
                        if (found) {
                            products = [found, ...products.filter(p => p.barcode !== searchBarcode)];
                        }
                    }
                    products.forEach(prod => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
              <td>${prod.barcode}</td>
              <td>${prod.name}</td>
              <td>₹${Number(prod.price).toFixed(2)}</td>
              <td>
                <button class="btn" onclick="showEditModal('${prod._id}')">Edit</button>
                <button class="btn" onclick="deleteProduct('${prod._id}')">Delete</button>
              </td>`;
                        tbody.appendChild(row);
                    });
                })
                .catch(() => showMessage("Failed to load products", "error"));
        }

        function showEditModal(id) {
            fetch(`${BASE_URL}/product/id/${id}`)
                .then(res => res.json())
                .then(prod => {
                    document.getElementById("edit-product-id").value = prod._id;
                    document.getElementById("edit-product-name").value = prod.name;
                    document.getElementById("edit-product-barcode").value = prod.barcode;
                    document.getElementById("edit-product-price").value = prod.price;
                    document.getElementById("edit-modal").style.display = "flex";
                })
                .catch(() => showMessage("Failed to load product details", "error"));
        }

        function closeEditModal() {
            document.getElementById("edit-modal").style.display = "none";
        }

        document.getElementById("add-product-form").addEventListener("submit", e => {
            e.preventDefault();
            const name = document.getElementById("product-name").value.trim();
            const barcode = document.getElementById("product-barcode").value.trim();
            const price = parseFloat(document.getElementById("product-price").value);

            if (!name || !barcode || isNaN(price)) {
                showMessage("Please enter valid product details", "error");
                return;
            }

            fetch(`${BASE_URL}/product`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, barcode, price }),
            })
                .then(res => res.json())
                .then(data => {
                    showMessage(data.message, data.success ? "success" : "error");
                    if (data.success) {
                        clearProductForm();
                        fetchProducts();
                    }
                })
                .catch(() => showMessage("Error adding product", "error"));
        });

        document.getElementById("edit-product-form").addEventListener("submit", e => {
            e.preventDefault();
            const id = document.getElementById("edit-product-id").value;
            const name = document.getElementById("edit-product-name").value.trim();
            const price = parseFloat(document.getElementById("edit-product-price").value);

            if (!name || isNaN(price)) {
                showMessage("Please enter valid details for update", "error");
                return;
            }

            fetch(`${BASE_URL}/product/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, price }),
            })
                .then(res => res.json())
                .then(data => {
                    showMessage(data.message, data.success ? "success" : "error");
                    if (data.success) {
                        closeEditModal();
                        fetchProducts();
                    }
                })
                .catch(() => showMessage("Error updating product", "error"));
        });

        function deleteProduct(id) {
            if (!confirm("Confirm product deletion?")) return;
            fetch(`${BASE_URL}/product/${id}`, { method: "DELETE" })
                .then(res => res.json())
                .then(data => {
                    showMessage(data.message, data.success ? "success" : "error");
                    if (data.success) fetchProducts();
                })
                .catch(() => showMessage("Error deleting product", "error"));
        }

        document.getElementById("barcode-search").addEventListener("input", e => {
            const q = e.target.value.trim();
            if (q.length === 12 && /^\d+$/.test(q)) {
                fetchProducts(q);
            } else if (q.length === 0) {
                fetchProducts();
            }
        });

        document.addEventListener("DOMContentLoaded", showMainPage);
    </script>
</body>

</html>
